##
# Harris vue Config
##
## 用户的 IP 地址 $binary_remote_addr 作为 Key，每个 IP 地址每秒处理 5 个请求
## 你想用程序每秒几百次的刷我，没戏，再快了就不处理了，直接返回 503 错误给你
## limit_req zone=req_limit_per_ip burst=30 nodelay; 最多 30 个排队， 由于每秒处理 5 个请求 + 30个排队，你一秒最多发送 35 个请求过来，再多就直接返回 503 错误给你了

limit_req_zone $binary_remote_addr zone=picethan_req_limit_per_ip:10m rate=5r/s;

log_format ethanpiclogformat '$remote_addr - $remote_user [$time_local] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent" "$gzip_ratio"'
                             'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"'
                             'request=$request_body'
                             'sslprotocol=$ssl_protocol $ssl_cipher '
                             ;

  server {
    listen 80;
    server_name apionline.pic.ethanphp;
    sendfile on;
 	

    ##
    # Nginx Bad Bot Blocker Includes
    # REPO: https://github.com/mitchellkrogza/nginx-ultimate-bad-bot-blocker
    #对比测试图
    #http://pic.c-ctrip.com/VacationH5Pic/mice/wechat/ewm01.png
    ##
	include /etc/nginx/bots.d/ddos.conf; 
 	include /etc/nginx/bots.d/blockbots.conf;
 
    ##
    # Gzip Settings
    ##
    gzip on;
    gzip_static on;
    gzip_http_version 1.1;
    gzip_disable      "MSIE [1-6]\.";
    gzip_min_length   1100;
    gzip_buffers 16 8k;
    gzip_vary         on;
    gzip_proxied      expired no-cache no-store private auth;
    gzip_types application/atom+xml application/x-javascript application/javascript application/json application/ld+json application/manifest+json application/xml+rss application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon image/webp image/apng image/* text/cache-manifest text/css text/xml text/plain text/javascript text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;
    gzip_comp_level   9;
    root /var/www/shareprj/ethanphp/site/jianghu_entertain/storage/statics/;
##########################################################
            location ~* ^.+\.(?:css|cur|swf|json|js|jpe?g|gif|htc|ico|png|txt|otf|ttf|eot|woff|woff2|svg|webp|webm|zip|gz|tar|rar)$ {
                limit_req zone=picethan_req_limit_per_ip burst=30 nodelay;
                set $test_http_origin a;
                if ($http_origin != "") {
                  set $test_http_origin x;
                }
                if ($http_origin != "${scheme}://${host}") {
                  set $test_http_origin "${test_http_origin}x";
                }
                if ($test_http_origin = xx) {
                  add_header "Access-Control-Allow-Origin" "*";
                }
                if ($request_method = 'OPTIONS') {
                            add_header 'Access-Control-Allow-Origin' '*';

                            #
                            # Om nom nom cookies
                            #

                            add_header 'Access-Control-Allow-Credentials' 'true';
                            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
                            #
                            # Custom headers and headers various browsers *should* be OK with but aren't
                            #

                            add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

                            #
                            # Tell client that this pre-flight info is valid for 20 days
                            #

                            add_header 'Access-Control-Max-Age' 1728000;
                            add_header 'Content-Type' 'text/plain charset=UTF-8';
                            add_header 'Content-Length' 0;

                            return 204;

             }
             if ($request_method = 'GET') {
                 add_header 'Access-Control-Allow-Origin' '*';
                         add_header 'Access-Control-Allow-Credentials' 'true';
                         add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                         add_header 'Access-Control-Allow-Headers' 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';
              }
                #access_log off;
                expires 30d;
                ## No need to bleed constant updates. Send the all shebang in one
                ## fell swoop.
                #tcp_nodelay off;
                ## Set the OS file cache.
                open_file_cache max=3000 inactive=120s;
                open_file_cache_valid 45s;
                open_file_cache_min_uses 2;
                open_file_cache_errors off;
                try_files $uri $uri/ @cache;
                error_page  405     =200 $uri ;
              }

       ########################## Check Request Methods and Some Bots ##############################################################
        ## Only allow these request methods ##
        if ($request_method !~ ^(GET|HEAD|OPTIONS)$ ) {
                  return 503;
                 #return 444;
        }
        ## Do not accept DELETE, SEARCH and other methods ##########################
        ## Block download agents
        #PostmanRuntime/7.22.0
        #Apache-HttpClient/4.5.10 (Java/11.0.5)
        #RestSharp 106.6.10.0"
        ##
        if ($http_user_agent ~* LWP::Simple|BBBike|wget|PostmanRuntime|Apache-HttpClient|RestSharp) {
             return 503;
             #return 403;
        }
        ## Block some robots ##
        if ($http_user_agent ~* msnbot|scrapbot|Catall|Spider|AcoiRobot) {
            return 503;
            #return 403;
        }
        ## Deny certain Referers ###
        if ( $http_referer ~* (babes|forsale|girl|jewelry|love|nudit|organic|poker|porn|sex|teen) )
        {
          return 503;
          #return 403;
        }
      ##############################################################################################################################
     error_log /var/log/nginx/jianghu_pic_error_ethan.log;
     access_log /var/log/nginx/jianghu_pic_access_ethan.log ethanpiclogformat;

     error_page 503 /503.html;
            location = /503.html {
              root /usr/share/nginx/html;
              internal;
            }
  }
